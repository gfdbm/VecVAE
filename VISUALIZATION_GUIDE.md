# è®­ç»ƒå¯è§†åŒ–æŒ‡å—

## ğŸ“Š æ¦‚è¿°

è®­ç»ƒè„šæœ¬ä¼šåœ¨å¤šä¸ªæ—¶é—´ç‚¹è‡ªåŠ¨å¯¼å‡ºçŸ¢é‡å¯è§†åŒ–ç»“æœï¼Œå¸®åŠ©ä½ ç›‘æ§è®­ç»ƒè¿›åº¦å’Œè´¨é‡ã€‚

## ğŸ¯ å¯è§†åŒ–æ—¶é—´ç‚¹

### 1. **åˆå§‹çŠ¶æ€ï¼ˆEpoch 0ï¼‰**
è®­ç»ƒå¼€å§‹å‰ï¼Œå¯¼å‡ºæœªè®­ç»ƒæ¨¡å‹çš„è¾“å‡º
- **ç›®çš„**: å»ºç«‹åŸºçº¿ï¼Œå¯¹æ¯”è®­ç»ƒæ•ˆæœ
- **ä½ç½®**: `{output_dir}/eval_previews/preview_eval_ep0_*.{txt,png}`
- **æ•°é‡**: é»˜è®¤ 4 ä¸ªæ ·æœ¬

### 2. **è®­ç»ƒè¿‡ç¨‹ä¸­ï¼ˆæ¯ N æ­¥ï¼‰**
è®­ç»ƒå¾ªç¯ä¸­å®šæœŸå¯¼å‡º
- **ç›®çš„**: å®æ—¶ç›‘æ§è®­ç»ƒè¿›åº¦
- **ä½ç½®**: `{output_dir}/preview_train_ep{epoch}_step{step}_b{batch_idx}.{txt,png}`
- **é¢‘ç‡**: ç”± `--export-every` å‚æ•°æ§åˆ¶ï¼ˆé»˜è®¤ 1000 æ­¥ï¼‰
- **æ•°é‡**: é»˜è®¤ 4 ä¸ªæ ·æœ¬

### 3. **æ¯ä¸ª Epoch ç»“æŸ**
æ¯å®Œæˆä¸€ä¸ª epoch åå¯¼å‡ºéªŒè¯é›†ç»“æœ
- **ç›®çš„**: è¯„ä¼°æ¯ä¸ª epoch çš„æ€§èƒ½
- **ä½ç½®**: `{output_dir}/eval_previews/preview_eval_ep{N}_*.{txt,png}`
- **æ•°é‡**: é»˜è®¤ 4 ä¸ªæ ·æœ¬

### 4. **è®­ç»ƒå®Œæˆ**
æœ€ç»ˆçŠ¶æ€çš„è¯¦ç»†å¯è§†åŒ–
- **ç›®çš„**: å…¨é¢å±•ç¤ºæœ€ç»ˆè®­ç»ƒç»“æœ
- **ä½ç½®**: `{output_dir}/eval_previews/preview_eval_ep999_*.{txt,png}`
- **æ•°é‡**: æœ€å¤š 16 ä¸ªæ ·æœ¬

## ğŸ“ æ–‡ä»¶æ ¼å¼è¯´æ˜

### TXT æ–‡ä»¶ï¼ˆçº¯æ–‡æœ¬çŸ¢é‡å‘½ä»¤ï¼‰
```
M 123.456 789.012
L 234.567 890.123
Q 345.678 901.234 456.789 012.345
Z
<NEW_CNT>
M 567.890 123.456
...
```

**å‘½ä»¤è¯´æ˜**:
- `M x y`: MoveTo - ç§»åŠ¨åˆ°åæ ‡ (x, y)
- `L x y`: LineTo - ç”»ç›´çº¿åˆ° (x, y)
- `Q cx cy x y`: QuadraticTo - ç”»äºŒæ¬¡è´å¡å°”æ›²çº¿ï¼Œæ§åˆ¶ç‚¹ (cx, cy)ï¼Œç»ˆç‚¹ (x, y)
- `Z`: ClosePath - é—­åˆè·¯å¾„
- `<NEW_CNT>`: æ–°è½®å»“å¼€å§‹
- `<HOLE>`: æ´ï¼ˆç”¨äºå¤æ‚å­—å½¢ï¼‰
- `<END>`: åºåˆ—ç»“æŸ

### PNG æ–‡ä»¶ï¼ˆä½å›¾å›¾åƒï¼‰
- ç™½åº•é»‘å­—ï¼Œ512x512 åƒç´ 
- ä½¿ç”¨ skia æ¸²æŸ“ï¼Œé«˜è´¨é‡æŠ—é”¯é½¿
- å¯ç›´æ¥åœ¨ä»»ä½•å›¾ç‰‡æŸ¥çœ‹å™¨ä¸­æ‰“å¼€
- é€‚åˆå¿«é€Ÿé¢„è§ˆå’Œå¯¹æ¯”

## ğŸ”§ ä½¿ç”¨æ–¹æ³•

### 1. å¼€å§‹è®­ç»ƒï¼ˆè‡ªåŠ¨å¯¼å‡ºï¼‰
```bash
python train.py \
    --npz data/msyh.npz \
    --use-rsm \
    --epochs 50 \
    --batch 8 \
    --export-every 1000 \
    --preview-n 4 \
    --out runs/experiment1
```

**å…³é”®å‚æ•°**:
- `--export-every`: è®­ç»ƒè¿‡ç¨‹å¯¼å‡ºé¢‘ç‡ï¼ˆæ­¥æ•°ï¼‰
- `--preview-n`: æ¯æ¬¡å¯¼å‡ºçš„æ ·æœ¬æ•°é‡
- `--out`: è¾“å‡ºç›®å½•

### 2. æŸ¥çœ‹å¯è§†åŒ–ç»“æœ

#### æ–¹æ³• A: ä½¿ç”¨æŸ¥çœ‹å™¨è„šæœ¬ï¼ˆæ¨èï¼‰
```bash
# æŸ¥çœ‹æœ€æ–° epoch
python view_results.py --out runs/experiment1

# æŸ¥çœ‹ç‰¹å®š epoch
python view_results.py --out runs/experiment1 --epoch 10

# æŸ¥çœ‹åˆå§‹çŠ¶æ€
python view_results.py --out runs/experiment1 --initial

# æŸ¥çœ‹æœ€ç»ˆç»“æœ
python view_results.py --out runs/experiment1 --final

# åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„ epoch
python view_results.py --out runs/experiment1 --list

# æŸ¥çœ‹æ›´å¤šæ ·æœ¬
python view_results.py --out runs/experiment1 --max-samples 16
```

#### æ–¹æ³• B: æ‰‹åŠ¨æµè§ˆ
```bash
# è¿›å…¥è¯„ä¼°é¢„è§ˆç›®å½•
cd runs/experiment1/eval_previews

# ç”¨å›¾ç‰‡æŸ¥çœ‹å™¨æ‰“å¼€ PNG æ–‡ä»¶
eog preview_eval_ep10_step0_b0.png  # Linux GNOME
# æˆ–
feh preview_eval_ep10_step0_b0.png  # Linux è½»é‡çº§
# æˆ–ç›´æ¥ç”¨ç³»ç»Ÿé»˜è®¤ç¨‹åº
xdg-open preview_eval_ep10_step0_b0.png
```

#### æ–¹æ³• C: å‘½ä»¤è¡Œæ‰¹é‡æŸ¥çœ‹
```bash
# åˆ—å‡ºæ‰€æœ‰å¯¼å‡ºçš„æ–‡ä»¶
ls -lh runs/experiment1/eval_previews/*.png

# ç»Ÿè®¡å„ä¸ª epoch çš„å¯¼å‡ºæ•°é‡
ls runs/experiment1/eval_previews/preview_eval_ep*.png | \
    sed 's/.*_ep\([0-9]*\)_.*/\1/' | sort -n | uniq -c

# ä½¿ç”¨ ImageMagick æ‰¹é‡æŸ¥çœ‹
montage runs/experiment1/eval_previews/preview_eval_ep10_*.png \
    -tile 4x1 -geometry 256x256+2+2 comparison_ep10.png
```

## ğŸ“ˆ ç›‘æ§è®­ç»ƒè´¨é‡

### å¯¹æ¯”ä¸åŒé˜¶æ®µ

1. **åˆå§‹çŠ¶æ€ (epoch 0)**: éšæœºå™ªå£°æˆ–ç®€å•å½¢çŠ¶
2. **æ—©æœŸè®­ç»ƒ (epoch 1-5)**: å¼€å§‹å‡ºç°å­—å½¢è½®å»“
3. **ä¸­æœŸè®­ç»ƒ (epoch 10-20)**: è½®å»“æ¸…æ™°ï¼Œç»†èŠ‚é€æ¸å®Œå–„
4. **åæœŸè®­ç»ƒ (epoch 30-50)**: ç»†èŠ‚ç²¾ç»†ï¼Œæ¥è¿‘çœŸå®å­—ä½“

### è´¨é‡æ£€æŸ¥ç‚¹

- âœ… **è½®å»“å®Œæ•´æ€§**: æ£€æŸ¥æ˜¯å¦æœ‰æ–­è£‚æˆ–ç¼ºå¤±çš„ç¬”ç”»
- âœ… **å‡ ä½•å‡†ç¡®æ€§**: å¯¹æ¯”åŸå§‹å­—ä½“ï¼Œæ£€æŸ¥å½¢çŠ¶æ˜¯å¦å‡†ç¡®
- âœ… **å¹³æ»‘åº¦**: æ›²çº¿æ˜¯å¦å¹³æ»‘ï¼Œæœ‰æ— é”¯é½¿
- âœ… **æ´çš„æ­£ç¡®æ€§**: å¦‚"æ—¥"ã€"ç›®"ç­‰å­—çš„å†…éƒ¨ç©ºæ´æ˜¯å¦æ­£ç¡®
- âœ… **æ¯”ä¾‹åè°ƒ**: ç¬”ç”»ç²—ç»†ã€é—´è·æ˜¯å¦åˆç†

## ğŸ› ï¸ é«˜çº§ç”¨æ³•

### è‡ªå®šä¹‰å¯¼å‡ºé¢‘ç‡

```python
# åœ¨ train.py ä¸­ä¿®æ”¹
parser.add_argument("--export-every", type=int, default=500)  # æ›´é¢‘ç¹
parser.add_argument("--preview-n", type=int, default=8)       # æ›´å¤šæ ·æœ¬
```

### å¯¼å‡ºç‰¹å®šå­—ç¬¦

ä¿®æ”¹è¯„ä¼°å‡½æ•°ï¼Œé€‰æ‹©ç‰¹å®šçš„å­—ç¬¦ï¼š

```python
# åœ¨ evaluate() ä¸­
# åŸä»£ç : indices = list(range(0, min(n, batch_size)))
# ä¿®æ”¹ä¸ºé€‰æ‹©ç‰¹å®šç´¢å¼•
specific_chars = [0, 10, 100, 500, 1000]  # é€‰æ‹©ç‰¹å®šæ ·æœ¬
indices = specific_chars[:batch_size]
```

### ç”Ÿæˆå¯¹æ¯”å›¾

```bash
# åˆ›å»ºå¯¹æ¯”è„šæœ¬
# compare_epochs.py
import matplotlib.pyplot as plt
from pathlib import Path

def compare_epochs(out_dir, sample_idx=0):
    epochs = [0, 10, 20, 30, 40, 50]
    fig, axes = plt.subplots(2, 3, figsize=(15, 10))
    
    for idx, ep in enumerate(epochs):
        svg_path = out_dir / f"eval_previews/preview_eval_ep{ep}_step0_b{sample_idx}.svg"
        # åŠ è½½å¹¶æ˜¾ç¤º SVG
        # ... å®ç°ä»£ç  ...
    
    plt.tight_layout()
    plt.savefig(out_dir / "training_progress.png", dpi=150)
```

## ğŸ“Š ç›®å½•ç»“æ„

è®­ç»ƒåçš„è¾“å‡ºç›®å½•ç»“æ„ï¼š

```
runs/experiment1/
â”œâ”€â”€ ckpt/                          # æ£€æŸ¥ç‚¹
â”‚   â”œâ”€â”€ epoch1.pt
â”‚   â”œâ”€â”€ epoch2.pt
â”‚   â””â”€â”€ ...
â”œâ”€â”€ eval_previews/                 # è¯„ä¼°å¯è§†åŒ–
â”‚   â”œâ”€â”€ preview_eval_ep0_step0_b0.png
â”‚   â”œâ”€â”€ preview_eval_ep0_step0_b0.txt
â”‚   â”œâ”€â”€ preview_eval_ep1_step0_b0.png
â”‚   â”œâ”€â”€ preview_eval_ep1_step0_b0.txt
â”‚   â””â”€â”€ ...
â”œâ”€â”€ preview_train_ep1_step1000_b0.png  # è®­ç»ƒè¿‡ç¨‹å¯è§†åŒ–
â”œâ”€â”€ preview_train_ep1_step1000_b0.txt
â”œâ”€â”€ train_log.csv                  # CSV æ—¥å¿—
â”œâ”€â”€ events.jsonl                   # JSONL æ—¥å¿—
â”œâ”€â”€ class_weight.pt               # ç±»åˆ«æƒé‡
â”œâ”€â”€ initial_eval.json             # åˆå§‹è¯„ä¼°
â”œâ”€â”€ last_eval.json                # æœ€æ–°è¯„ä¼°
â””â”€â”€ final_eval.json               # æœ€ç»ˆè¯„ä¼°
```

## ğŸ’¡ æŠ€å·§ä¸å»ºè®®

1. **å®šæœŸæ£€æŸ¥å¯è§†åŒ–**: ä¸è¦åªçœ‹æŸå¤±æ›²çº¿ï¼Œè§†è§‰æ£€æŸ¥å¾ˆé‡è¦
2. **ä¿å­˜å…³é”®æ—¶åˆ»**: å‘ç°å¥½çš„ç»“æœæ—¶ç«‹å³å¤‡ä»½å¯¹åº”çš„ checkpoint
3. **å¯¹æ¯”å¤šä¸ªæ ·æœ¬**: å•ä¸ªæ ·æœ¬å¯èƒ½æœ‰å¶ç„¶æ€§ï¼Œå¤šçœ‹å‡ ä¸ª
4. **æ³¨æ„å¼‚å¸¸**: å¦‚æœæŸäº›æ ·æœ¬è´¨é‡çªç„¶ä¸‹é™ï¼Œå¯èƒ½è®­ç»ƒå‡ºç°é—®é¢˜
5. **ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶**: ä¸ºä¸åŒå®éªŒåˆ›å»ºä¸åŒçš„è¾“å‡ºç›®å½•

## â“ å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆæœ‰äº› PNG æ–‡ä»¶çœ‹èµ·æ¥æ˜¯ç©ºç™½çš„ï¼Ÿ
A: å¯èƒ½æ˜¯æ¨¡å‹è¿˜æ²¡å­¦å¥½ï¼Œæˆ–è€…è¯¥æ ·æœ¬çš„å‰ç¼€å¤ªçŸ­ã€‚æ£€æŸ¥å¯¹åº”çš„ TXT æ–‡ä»¶çœ‹å‘½ä»¤æ˜¯å¦æ­£å¸¸ã€‚

### Q: å¦‚ä½•æé«˜å¯¼å‡ºè´¨é‡ï¼Ÿ
A: 
- å¢åŠ  `--preview-n` æ•°é‡
- é™ä½ `--export-every` é¢‘ç‡
- åœ¨è¯„ä¼°æ—¶ä½¿ç”¨æ›´å¤§çš„ batch_size

### Q: å¯¼å‡ºå¤ªæ…¢æ€ä¹ˆåŠï¼Ÿ
A: 
- å‡å°‘ `--preview-n`
- å¢åŠ  `--export-every`ï¼ˆå‡å°‘å¯¼å‡ºé¢‘ç‡ï¼‰
- è¯„ä¼°æ—¶è®¾ç½® `export_vis=False`

### Q: å¦‚ä½•å¯¼å‡ºåŸå§‹å­—ä½“è¿›è¡Œå¯¹æ¯”ï¼Ÿ
A: ä½¿ç”¨æ•°æ®é›†çš„ `img_dt_full` æˆ–åŸå§‹å­—ä½“æ–‡ä»¶è¿›è¡Œæ¸²æŸ“å¯¹æ¯”ã€‚

## ğŸ”— ç›¸å…³æ–‡ä»¶

- `train.py`: ä¸»è®­ç»ƒè„šæœ¬
- `view_results.py`: å¯è§†åŒ–æŸ¥çœ‹å™¨
- `src/utils/vec_export.py`: çŸ¢é‡å¯¼å‡ºå·¥å…·
- `src/data/stage_renderer.py`: SDF æ¸²æŸ“å™¨

---

ç¥è®­ç»ƒé¡ºåˆ©ï¼å¦‚æœ‰é—®é¢˜è¯·æŸ¥çœ‹æ—¥å¿—æˆ–è°ƒæ•´å‚æ•°ã€‚

